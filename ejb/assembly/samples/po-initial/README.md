# Sample: PurchaseOrder JPA & JAXB

This Maven project demonstrates the generation of JPA Entities from an XML Schema file (xsd) using the [HiSrc HyperJAXB Maven Plugin][9]. The generated classes include JPA and JAXB annotations to support JDBC persistence and XML marshaling/unmarshaling. Further, it uses [HiSrc BasicJAXB XJC Plugins][10] plugins to add custom `hashCode`, `equals`, and `toString` implementations to each generated entity.

### Problem ( from [StackOverflow](https://stackoverflow.com/questions/30086493/) )

+ Can [Eclipselink][15] be a viable approach for mapping between certain properties of existing complex JAXB types and ideally designed RDBMS schemas?
+ If it's so, how can special cases be handled?

### Solution

Yes, [Eclipselink][15] is a viable approach for mapping between certain properties of existing complex JAXB types and ideally designed RDBMS schemas. 

> To demonstrate, [HiSrc HyperJAXB Maven Plugin][9] is used to read your XML Schema (xsd) file(s) and XML Schema Binding (xjb) file(s) to generate Java Entity classes with JPA and JAXB annotations. **Note:** The source/target (release) compatibility for *HyperJAXB* is at Java 11, up from Java 8. And, JDK 17 is used for the build. JAXB dependencies are at version 4.x for [Jakarta EE 10][12]. JPA dependencies are at 2.1.

Special cases are handled using XML *appinfo* annotations in the XSD file(s) *and/or* schema bindings in the XJB file(s). The JAXB XJC compiler accepts plugins to customize how it generates the entities and these plugins provide XML namespaces for use in your XSD and XJB file(s). Here is a list of typical XJC plugins:

+ `xmlns:annox="http://jvnet.org/basicjaxb/xjc/annox"`
+ `xmlns:basic="http://jvnet.org/basicjaxb/xjc"`
+ `xmlns:customizations="http://jvnet.org/basicjaxb/xjc/customizations"`
+ `xmlns:hj="http://jvnet.org/hyperjaxb/jpa"`
+ `xmlns:inheritance="http://jvnet.org/basicjaxb/xjc/inheritance"`
+ `xmlns:jaxb="https://jakarta.ee/xml/ns/jaxb"`
+ `xmlns:jl="http://jvnet.org/basicjaxb/xjc/annox/java.lang"`
+ `xmlns:simplify="http://jvnet.org/basicjaxb/xjc/simplify"`
+ `xmlns:vc="http://jvnet.org/basicjaxb/xjc/valueconstructor"`
+ `xmlns:wildcard="http://jvnet.org/basicjaxb/xjc/wildcard"`

The **JPA/JAXB** classes are generated by the [*HiSrc HyperJAXB Maven Plugin*][9] in this project's [pom.xml][3]

~~~
<plugin>
    <groupId>org.patrodyne.jvnet</groupId>
    <artifactId>hisrc-hyperjaxb-maven-plugin</artifactId>
    <version>\${hisrc-hyperjaxb.version}</version>
    <executions>
        <execution>
            <id>generate</id>
            <goals>
                <goal>generate</goal>
            </goals>
            <configuration>
                <extension>true</extension>
            </configuration>
        </execution>
    </executions>
</plugin>
~~~

and are generated to:

~~~
target/generated-sources
├── apt
│   └── org
│       └── example
│           └── po
│               ├── Item_.java
│               ├── Items_.java
│               ├── PurchaseOrder_.java
│               └── USAddress_.java
└── xjc
    ├── META-INF
    │   ├── persistence.xml
    │   └── sun-jaxb.episode
    └── org
        └── example
            └── po
                ├── Item.java
                ├── Items.java
                ├── ObjectFactory.java
                ├── package-info.java
                ├── PurchaseOrder.java
                └── USAddress.java

target/test-database-sql
├── ddl-create.sql
└── ddl-drop.sql
~~~

[Here (zip)][1] is a Maven project named **po-initial** with the standard layout. This project includes:

+ The Maven POM file with `hisrc-hyperjaxb-maven-plugin`
+ A [Main][11] class to demonstrate a simple use case.
+ Resources
    + [jvmsystem.properties][18] to select an *H2* or *PostgreSQL* database.
    + [persistence\*.properties][19] to configure the `EntityManagerFactory`.
    + [META-INF/orm.xml][20] to configure the database schema name.
    + An XML Schema file [PurchaseOrder.xsd][4] for the `PurchaseOrder` model
    + A JAXB *binding* file [PurchaseOrder.xjb][6] for configuration
+ A JUnit test class [RoundtripTest.java][7] to verify unmarshalling, persistence and marshaling.
+ Sample XML [file(s)][8] with `purchaseOrder` data.

~~~
hisrc-hyperjaxb-ejb-sample-po-initial-2.1.0
├── pom.xml
└── src
    ├── main
    │   ├── java
    │   │   └── org
    │   │       └── example
    │   │           └── po
    │   │               ├── Context.java
    │   │               └── Main.java
    │   └── resources
    │       ├── jvmsystem.arguments
    │       ├── jvmsystem.properties
    │       ├── META-INF
    │       │   └── orm.xml
    │       ├── persistence-h2.properties
    │       ├── persistence-pg.properties
    │       ├── persistence.properties
    │       ├── PurchaseOrder.xjb
    │       ├── PurchaseOrder.xsd
    │       └── simplelogger.properties
    └── test
        ├── java
        │   └── org
        │       └── example
        │           └── po
        │               └── RoundtripTest.java
        ├── resources
        │   ├── persistence-pg-create-database.sql
        │   └── persistence-pg-recreate-schema.sql
        └── samples
            └── po.xml
~~~

#### Execution

This is a stand-alone Maven project. You can run the test and/or application using either of two JPA providers:

**[Eclipselink][15]**
~~~
mvn -Peclipselink clean test
mvn -Peclipselink clean compile exec:java
~~~

or

**[Hibernate][16]**
~~~
mvn -Phibernate clean test
mvn -Phibernate clean compile exec:java
~~~

This [output][2] shows the test results using *Eclipselink*.

##### Persistence: H2 or PostgreSQL

By default, this project uses a local [H2][13] database. The H2 database is automatically created when the application creates its `EntityManagerFactory`.

Alternatively, this project can be re-configured to use your own [PostgreSQL][14] database server.

##### Approach

The [hisrc-hyperjaxb-maven-plugin][9] is configured to generate **JPA/JAXB** classes using the provided [PurchaseOrder.xsd][4] schema. The schema provides the namespace `"http://org.example/po"` which **JAXB** uses to create the Java `package` name using its own naming convention.

As the default option, a more advanced implementation of Java's built-in `Object` methods are generated using these **XJC** [hisrc-basicjaxb-plugins][10]. In particular, the sample project uses the `toString` plugin to display *human-readable* representations of the unmarshaled `PurchaseOrder` objects.

> *Note:* The [hisrc-hyperjaxb-maven-plugin][9] extends the [hisrc-higherjaxb-maven-plugin][17] but *pre-configures* several of the **XJC** [hisrc-basicjaxb-plugins][10]; thus, the [hisrc-basicjaxb-runtime][10] dependency is required on the run-time class path. For more help on the configuration details, see ...

~~~
mvn hisrc-hyperjaxb:help -Ddetail=true
~~~

##### Testing

The JUnit test class, [RoundtripTest.java][7], scans for the sample files and invokes the method `super.checkSample(File sample)` to provide each file to the tester. For this project, an `EntityManagerFactory` and a `JAXBContext` are created and each file in the [samples][8] path is:

+ *unmarshaled* to an initial `PurchaseOrder` object
+ *unmarshaled* to an etalon `PurchaseOrder` object
+ A JPA transaction is started.
    + The initial object is *merged* into the persistence session
+ The JPA transaction is committed
+ A new JPA `EntityManager`, *em*, instance is created
    + The new *em* is used to load the persisted PO by id
    + The etalon, merged and loaded PO objects are compared for equality
+ The *em* is closed and each PO object is marshaled for review in the logs

When successful, each object is *marshaled* for logging and your [review][2].

##### Demonstration

A Java standard engine application with a `main(...)` method is at [`org.example.po.Main`][11]. This application is executed using:

~~~
mvn -Peclipselink clean compile exec:java -Dexec.args="src/test/samples/po.xml"
OR
mvn -Phibernate   clean compile exec:java -Dexec.args="src/test/samples/po.xml"
~~~

<!-- References -->

[1]: https://github.com/patrodyne/hisrc-hyperjaxb/releases/download/2.1.0/hisrc-hyperjaxb-sample-po-initial-2.1.0-mvn-src.zip
[2]: https://github.com/patrodyne/hisrc-hyperjaxb/blob/master/ejb/assembly/samples/po-initial/OUTPUT.txt
[3]: https://github.com/patrodyne/hisrc-hyperjaxb/blob/master/ejb/assembly/samples/po-initial/project-pom.xml
[4]: https://github.com/patrodyne/hisrc-hyperjaxb/blob/master/ejb/assembly/samples/po-initial/src/main/resources/PurchaseOrder.xsd
[5]: https://github.com/patrodyne/hisrc-hyperjaxb/blob/master/ejb/assembly/samples/po-initial/src/test/samples/po.xml
[6]: https://github.com/patrodyne/hisrc-hyperjaxb/blob/master/ejb/assembly/samples/po-initial/src/main/resources/PurchaseOrder.xjb
[7]: https://github.com/patrodyne/hisrc-hyperjaxb/blob/master/ejb/assembly/samples/po-initial/src/test/java/org/example/po/RoundtripTest.java
[8]: https://github.com/patrodyne/hisrc-hyperjaxb/tree/master/ejb/assembly/samples/po-initial/src/test/samples
[9]: https://github.com/patrodyne/hisrc-hyperjaxb#readme
[10]: https://github.com/patrodyne/hisrc-basicjaxb#readme
[11]: https://github.com/patrodyne/hisrc-hyperjaxb/blob/master/ejb/assembly/samples/po-initial/src/main/java/org/example/po/Main.java
[12]: https://jakarta.ee/specifications/xml-binding/
[13]: https://www.h2database.com/
[14]: https://www.postgresql.org/
[15]: https://www.eclipse.org/eclipselink/
[16]: https://hibernate.org/orm/
[17]: https://github.com/patrodyne/hisrc-higherjaxb#readme
[18]: https://github.com/patrodyne/hisrc-hyperjaxb/blob/master/ejb/assembly/samples/po-initial/src/main/resources/jvmsystem.properties
[19]: https://github.com/patrodyne/hisrc-hyperjaxb/tree/master/ejb/assembly/samples/po-initial/src/main/resources
[20]: https://github.com/patrodyne/hisrc-hyperjaxb/blob/master/ejb/assembly/samples/po-initial/src/main/resources/META-INF/orm.xml
